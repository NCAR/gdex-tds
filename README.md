# GDEX TDS CIRRUS Deployment

## Concepts
- Kubernetes(k8s)-Cirrus <= TDS deployed through Helm Chart <= Harbor container registry <= GitHub Action container push
- the repository main branch PR push would trigger the container build and push to registry
- Helm chart folder will help the CIRRUS to get the container in the registry and deploy them

## Github repository
Here's the repository tree for the NCAR/gdex-tds GitHub repository:

```
gdex-tds/
├── .github/
├── LICENSE
├── rda-tds-helm/ (CIRRUS deployment)
│       ├── Chart.yaml
│       ├── values.yaml
│       └── templates/
│           ├── deployment.yaml
│           ├── ....
├── src (useful python exec to create xml and ctl)
│            
└── rda-tds  (actual TDS code)
    ├── content
    └── ...
```
    
- **`rda-tds-helm` : the kubernate deployment related (change in here will not trigger deployement)**
    - `Chart` : Helm Chart (viewable in ARGO CD)
    - `values` : define the variable values that is going to be use in the `templates`
    - `templates` : where the actual individual deployment script
        - deployment.yaml
            - contain all containers deploynment
            - needed resources, ports, vol mounts (persistent volume) so the container can access and not disapear when the container/pod is dropped
            - containers include
                - TDS deploy include 3 mount (data, log, indexfile-xml)
                - Log include 1 mount (log)
                    - cat all log and can be viewed on Grafana
                    - if not done one can only view if login to the exec pod
                - TDM thredds data management 2 mount (data, indexfile-xml)
- `rda-tds` : where all the TDS detail is located including index files and stuff
    - `logs` : where all logs are located (empty but place to store log when deployed)
    - `content` : all xml cat
        - `catalog.xml` : all data catelog
        - `catalog_d010079.xml` : individual data catelog (can be generated by `src/createXML.py`)
        - `threddsConfig.xml` : detail configuration for the TDS appearance
        - `template/tdsTemplateFragments.html` : the html for the TDS appearance
- `src` : python scripts generating the control file for `dsrqst` or xml file for TDS
    - `createCTL.py` : create the rda control file to be added so the webpage can see the TDS column
        - `dsrqst -sc -ds d010079 -if d010079.ctl -nc -md`
    - `createXML.py` : create the xml catalog

## K8s health check

- ARGO CD - check the chart and pod run health
- Grafana - check the log and usage

## Useful info

- command line on the deployed docker image
```
kubectl exec -it deploy/rda-tds -n rda -c rda-tds -- /bin/bash`
```    
- useful CIRRUS intro
    - https://ncar-hpc-docs.readthedocs.io/en/latest/compute-systems/cirrus/guides/01-intro/

## Local installation for debug
- [Azure kubelogin](https://azure.github.io/kubelogin/install.html)
- [kubectl](https://kubernetes.io/docs/tasks/tools/#kubectl)